import os
import pandas as pd
import torch
import torchvision
import torchaudio
import decord
from torch.utils.data import Dataset
from typing import Callable
import math
import sys
import datetime
import gc

df = pd.read_csv("/data/datasets/ETRI_resize/etri.tsv", sep='\t', encoding='utf-8')
print(df)

file_name = [
    "",
    "220918_남정희_김우진",
    "220918_남정희_백보경",
    "220918_남정희_손석규",
    "220918_남정희_정정연",
    "220918_남정희_차지수",
    "220920_강명진_오주현",
    "220920_강명진_윤수진",
    "220920_강명진_정은영",
    "220920_강명진_조주현",
    "220922_강명진_오은숙",
    "220922_강명진_정준호",
    "220922_강주영_강태랑",
    "220922_강주영_김은영",
    "220922_강주영_이준혁",
    "220922_강주영_정유림",
    "220922_강주영_최보규",
    "220925_남정희_김민석",
    "220925_남정희_박종길",
    "220925_남정희_서지원",
    "220925_남정희_서혜연",
    "220925_남정희_이주왕",
    "220925_남정희_장은태",
    "220925_남정희_한성민",
    "220925_남정희_허세민",
    "220929_강명진_김민수",
    "220929_강명진_김정현",
    "220929_강명진_류호정",
    "220929_강명진_유채이",
    "220929_강주영_김영미",
    "220929_강주영_류서영",
    "220929_강주영_송선희",
    "220929_강주영_임지윤",
    "221006_윤지선_박일용",
    "221006_윤지선_안수진",
    "221006_윤지선_용금여",
    "221006_윤지선_임현숙",
    "221006_윤지선_조영현",
    "221006_윤지선_채원석",
    "221006_윤지선_최주희",
    "220918_남정희_김지수",
]


for i in range(1, len(file_name) + 1):
    os.system(f'mkdir /data/datasets/ETRI_resize/{i}')

# for i in range(len(file_name)):
#     if i == 0:
#         pass
#     if i < 31:
#         continue
#     path = os.path.join("/data/datasets/ETRI_Backchannel_Corpus_2022", file_name[i], "'1. 상담자 녹음본.wav'")
#     os.system(f'cp {path} /data/datasets/ETRI_resize/{i}/counselor.wav')
#     path = os.path.join("/data/datasets/ETRI_Backchannel_Corpus_2022", file_name[i], "'2. 내담자 녹음본.wav'")
#     os.system(f'cp {path} /data/datasets/ETRI_resize/{i}/client.wav')
#     path = os.path.join("/data/datasets/ETRI_Backchannel_Corpus_2022", file_name[i], '"4. 상담자 인터뷰 영상.mp4"' if i > 10 else '"5. 상담자 인터뷰 영상.mp4"')
#     os.system(f'ffmpeg -y -i {path} -filter:v "crop=640:640:640:0,scale=224:224" /data/datasets/ETRI_resize/{i}/counselor.mp4')
#     path = os.path.join("/data/datasets/ETRI_Backchannel_Corpus_2022", file_name[i], '"5. 내담자 인터뷰 영상.mp4"' if i > 10 else '"6. 내담자 인터뷰 영상.mp4"')
#     os.system(f'ffmpeg -y -i {path} -filter:v "crop=640:640:640:0,scale=224:224" /data/datasets/ETRI_resize/{i}/client.mp4')

# badfile = [1526, 1527, 1529, 1531, 1534, 1536, 1538, 1540, 1542, 1544, 1545, 1546, 1548, 1550, 1552, 1554, 1557, 1558, 1560, 1564, 1566, 1568, 1571, 1575, 1576, 1578, 1580, 1582, 1585, 1590, 1593, 1595, 1597, 1600, 1602, 1605, 1607, 1609, 1613, 1617, 1620, 1623, 1625, 1628, 1630, 1631, 1633, 1635, 1637, 1638, 1640, 1642, 1644, 1645, 1648, 1650, 1652, 1655, 1658, 1660, 1663, 1665, 1667, 1669, 1671, 1673, 1676, 1678, 1680, 1681, 1682, 1683, 1685, 1688, 1689, 1691, 1692, 1694, 1695, 1697, 1699, 1701, 1703, 1704, 1706, 1708, 1710, 1711, 1713, 1715, 1718, 1721, 1723, 1725, 1727, 1732, 1734, 1737, 1739, 1740, 1742, 1744, 1747, 1750, 1752, 1754, 1755, 1757, 1759, 1762, 1764, 1767, 1768, 1771, 1773, 1775, 1778, 1781, 1783, 1785, 1786, 1789, 1793, 1796, 1799, 1801, 1806, 1808, 1809, 1811, 1813, 1815, 1819, 1822, 1823, 1825, 1826, 1828, 1830, 1832, 1834, 1836, 1838, 1843, 1845, 1847, 1850, 1853, 1855, 1859, 1861, 1863, 1864, 1866, 1868, 1873, 1875, 1878, 1880, 1882, 1884, 1886, 1888, 1890, 1893, 1903, 1907, 1909, 1911, 1914, 1917, 1925, 1927, 1929, 1931, 1934, 1937, 1942, 1944, 1948, 1951, 1953, 1956, 1957, 1959, 1963, 1965, 1968, 1970, 1971, 1975, 1977, 1979, 1982, 1984, 1987, 1989, 1991, 1993, 1995, 1997, 2000, 2003, 2006, 2008, 2009, 2011, 2013, 2015, 2017, 2019, 2022, 2024, 2026, 2028, 2029, 2031, 2033, 2035, 2037, 2039, 2040, 2042, 2044, 2047, 2049, 2051, 2054, 2055, 2058, 2061, 2063, 2066, 2067, 2068, 2071, 2078, 2080, 2083, 2085, 2088, 2090, 2092, 2094, 2096, 2098, 2099, 2101, 2103, 2104, 2108, 2112, 2113, 2115, 2117, 2121, 2122, 2123, 2125, 2127, 2129, 2130, 2132, 2133, 2135, 2137, 2138, 2139, 2141, 2142, 2145, 2147, 2151, 2154, 2596, 2597, 2598, 2599, 2600, 2601, 2602, 2603, 2604, 2605, 2606, 2607, 2608, 2609, 2610, 2611, 2612, 2613, 2614, 2615, 2616, 2617, 2618, 2619, 2620, 2621, 2622, 2623, 2624, 2625, 2626, 2627, 2628, 2629, 2630, 2631, 2632, 2633, 2634, 2635, 2636, 2637, 2638, 2639, 2640, 2641, 2642, 2643, 2644, 2645, 2646, 2647, 2648, 2649, 2650, 2651, 2652, 2653, 2654, 2655, 2656, 2657, 2658, 2659, 2660, 2661, 2662, 2663, 2664, 2665, 2666, 2667, 2668, 2669, 2670, 2671, 2672, 2673, 2674, 2675, 2676, 2677, 2678, 2679, 2680, 2681, 2682, 2683, 2684, 2685, 2686, 2687, 2688, 2689, 2690, 2691, 2692, 2693, 2694, 2695, 2696, 2697, 2698, 2699, 2700, 2701, 2702, 3350, 3351, 3352, 3353, 3354, 3355, 3356, 3357, 3358, 3359, 3360, 3361, 3362, 3363, 3364, 3365, 3366, 3367, 3368, 3369, 3370, 3371, 3372, 3373, 3374, 3375, 3376, 3377, 3378, 3379, 4374, 4375, 4376, 4377, 4378, 4379, 4380, 5297, 5298, 5299, 5300, 5301, 5302, 5303, 5304, 5305, 5306, 5307, 5308, 5309, 5310, 5311, 5312, 5313, 5314, 5315, 5316, 5317, 5318, 5319, 5320, 5321, 5322, 5323, 5324, 5325, 5326, 5327, 5328, 5329, 5330, 5331, 5332, 5333, 5334, 5335, 5336, 5337, 5338, 5339, 5340, 5341, 5342, 5343, 5344, 5345, 5346, 5347, 5348, 5349, 5350, 5351, 5352, 5353, 5354, 5355, 5356, 5357, 5358, 5359, 5360, 5361, 5362, 5363, 5364, 5365, 5366, 5367, 5368, 5369, 5370, 5371, 5372, 5373, 5374, 5375, 5376, 5377, 5378, 5379, 5380, 5381, 5382, 5383, 5384, 5385, 5386, 5387, 5388, 5389, 5390, 5391, 5392, 5393, 5394, 5395, 5396, 5397, 5398, 5399, 5400, 5401, 5402, 5403, 5404, 5405, 5406, 5407, 5408, 5409, 5410, 5411, 5412, 5413, 5414, 5415, 5416, 5417, 5418, 5419, 5420, 5421, 5422, 5423, 5424, 5425, 5426, 5427, 5428, 5429, 5430, 5431, 5432, 5433, 5434, 5435, 5436, 5437, 5438, 5439, 5440, 5441, 5442, 5443, 5444, 5445, 5446, 5447, 5448, 5449, 5450, 5451, 5452, 5453, 5454, 5455, 5456, 5457, 5458, 5459, 5460, 5461, 5462, 5463, 5464, 5465, 5466, 5467, 5468, 5469, 5470, 5471, 5472, 5473, 5474, 5475, 5476, 5477, 5478, 5479, 5480, 5481, 5482, 5483, 5484, 5485, 5486, 5487, 5488, 5489, 5490, 5491, 5492, 5493, 5494, 5495, 5496, 5497, 5498, 5499, 5500, 5501, 5502, 5503, 5504, 5505, 5506, 5507, 5508, 5509, 5510, 5511, 5512, 5513, 5514, 5515, 5516, 5517, 5518, 5519, 5520, 5521, 5522, 5523, 5524, 5525, 5526, 5527, 5528, 5529, 5530, 5531, 5532, 5533, 5534, 5535, 5536, 5537, 5538, 5539, 5540, 5541, 5542, 5543, 5544, 5545, 5546, 5547, 5548, 5549, 5550, 5551, 5552, 5553, 5554, 5555, 5556, 5557, 5558, 5559, 5560, 5561, 5562, 5563, 5564, 5565, 5566, 5567, 5568, 5569, 5570, 5571, 5572, 5573, 5574, 5575, 5576, 5577, 5578, 5579, 5580, 5581, 5582, 5583, 5584, 5585, 5586, 5587, 5588, 5589, 5590, 5591, 5592, 5593, 5594, 5595, 5596, 5597, 5598, 5599, 5600, 5601, 5602, 5603, 5604, 5605, 5606, 5607, 5608, 5609, 5610, 5611, 5612, 5613, 5614, 5615, 5616, 5617, 5618, 5619, 5620, 5621, 5622, 5623, 5624, 5625, 5626, 5627, 5628, 5629, 5630, 5631, 5632, 5633, 5634, 5635, 5636, 5637, 5638, 5639, 5640, 5641, 5642, 5643, 5644, 5645, 5646, 5647, 5648, 5649, 5650, 5651, 5652, 5653, 5654, 5655, 5656, 5657, 5658, 5659, 5660, 5661, 5662, 5663, 5664, 5665, 5666, 5667, 5668, 5669, 5670, 5671, 5672, 5673, 5674, 5675, 5676, 5677, 5678, 5679, 5680, 5681, 5682, 5683, 5684, 5685, 5686, 5687, 5688, 5689, 5690, 5691, 5692, 5693, 5694, 5695, 5696, 5697, 5698, 5699, 5700, 5701, 5702, 5703, 5704, 5705, 7349, 7350, 7351, 7352, 7353, 7354, 7355, 7356, 7357, 7358, 7359, 7360, 7361, 7362, 7363, 7364, 7365, 7366, 7915, 8255, 8256, 8257, 8258, 8259, 8260, 8261, 8262, 8263, 8264, 8265, 8266, 8267, 8268, 8269, 8270, 8271, 8272, 8273, 8274, 8275, 8276, 9285, 9286, 9287, 9288, 9289, 9290, 9291, 9292, 9293, 9294, 9295, 9296, 9297, 9298, 9299, 9300, 9301, 9302, 9303, 9304, 9305, 9306, 9307, 9308, 9309, 9310, 9311, 9312, 9313, 9314, 9315, 9316, 9317, 9318, 9319, 9320, 9321, 9322, 9323, 9324, 9325, 9326, 9327, 9328, 9329, 9330, 9331, 9332, 9333, 9334, 9335, 9336, 9337, 9338, 9339, 9340, 9341, 9342, 9343, 9344, 9345, 9346, 9347, 9348, 9349, 9350, 9351, 9352, 9353, 9354, 9355, 9356, 9357, 9358, 9359, 9360, 9361, 9362, 11332, 11333, 11334, 11335, 11336, 11337, 11338, 11339, 11340, 11341, 11342, 11343, 11344, 11345, 11346, 11347, 11348, 11349, 11350, 11351, 11352, 11353, 11354, 11355, 11356, 11357, 11358, 11359, 11360, 11361, 11362, 11363, 11364, 11365, 11366, 11367, 11368, 11369, 11370, 11371, 11372, 11373, 11374, 11375, 11376, 11377, 11378, 11379, 11380, 11381, 11382, 11383, 11384, 11385, 11386, 11387, 11388, 11389, 11390, 11391, 11392, 11393, 11394, 11395, 11396, 11397, 11398, 11399, 11400, 11401, 11402, 11403, 11404, 11405, 11406, 11407, 11408, 11409, 11410, 11411, 11412, 11413, 11414, 11878, 11879, 11880, 11881, 11882, 11883, 11884, 11885, 11886, 11887, 11888, 11889, 11890, 11891, 11892, 11893, 11894, 11895, 11896, 11897, 11898, 11899, 11900, 11901, 11902, 11903, 11904, 11905, 11906, 11907, 12626]
# badfile = [5413, 5414, 5415, 5416, 5417, 5418, 5419, 5420, 5421, 5422, 5423, 5424, 5425, 5426, 5427, 5428, 5429, 5430, 5431, 5432, 5433, 5434, 5435, 5436, 5437, 5438, 5439, 5440, 5441, 5442, 5443, 5444, 5445, 5446, 5447, 5448, 5449, 5450, 5451, 5452, 5453, 5454, 5455, 5456, 5457, 5458, 5459, 5460, 5461, 5462, 5463, 5464, 5465, 5466, 5467, 5468, 5469, 5470, 5471, 5472, 5473, 5474, 5475, 5476, 5477, 5478, 5479, 5480, 5481, 5482, 5483, 5484, 5485, 5486, 5487, 5488, 5489, 5490, 5491, 5492, 5493, 5494, 5495, 5496, 5497, 5498, 5499, 5500, 5501, 5502, 5503, 5504, 5505, 5506, 5507, 5508, 5509, 5510, 5511, 5512, 5513, 5514, 5515, 5516, 5517, 5518, 5519, 5520, 5521, 5522, 5523, 5524, 5525, 5526, 5527, 5528, 5529, 5530, 5531, 5532, 5533, 5534, 5535, 5536, 5537, 5538, 5539, 5540, 5541, 5542, 5543, 5544, 5545, 5546, 5547, 5548, 5549, 5550, 5551, 5552, 5553, 5554, 5555, 5556, 5557, 5558, 5559, 5560, 5561, 5562, 5563, 5564, 5565, 5566, 5567, 5568, 5569, 5570, 5571, 5572, 5573, 5574, 5575, 5576, 5577, 5578, 5579, 5580, 5581, 5582, 5583, 5584, 5585, 5586, 5587, 5588, 5589, 5590, 5591, 5592, 5593, 5594, 5595, 5596, 5597, 5598, 5599, 5600, 5601, 5602, 5603, 5604, 5605, 5606, 5607, 5608, 5609, 5610, 5611, 5612, 5613, 5614, 5615, 5616, 5617, 5618, 5619, 5620, 5621, 5622, 5623, 5624, 5625, 5626, 5627, 5628, 5629, 5630, 5631, 5632, 5633, 5634, 5635, 5636, 5637, 5638, 5639, 5640, 5641, 5642, 5643, 5644, 5645, 5646, 5647, 5648, 5649, 5650, 5651, 5652, 5653, 5654, 5655, 5656, 5657, 5658, 5659, 5660, 5661, 5662, 5663, 5664, 5665, 5666, 5667, 5668, 5669, 5670, 5671, 5672, 5673, 5674, 5675, 5676, 5677, 5678, 5679, 5680, 5681, 5682, 5683, 5684, 5685, 5686, 5687, 5688, 5689, 5690, 5691, 5692, 5693, 5694, 5695, 5696, 5697, 5698, 5699, 5700, 5701, 5702, 5703, 5704, 5705, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13402, 13403, 13404, 13405, 13406, 13407, 13408, 13409, 13410, 13411, 13412, 13413, 13414, 13415, 13416, 13417, 13418, 13419, 13420, 13421, 13422, 13423, 13424, 13425, 13426, 13427, 13428, 13429, 13430, 13431, 13432, 13433, 13434, 13435, 13436, 13437, 13438, 13439, 13440, 13441, 13442, 13443, 13444, 13445, 13446, 13447, 13448, 13449, 13450, 13451, 13452, 13453, 13454, 13455, 13456, 13457, 13458, 13459, 13460, 13461, 13462, 13463, 13464, 13465, 13466, 13467, 13468, 13469, 13470, 13471, 13472, 13473, 13474, 13475, 13476, 13477, 13478, 13479, 13480, 13481, 13482, 13483, 13484, 13485, 13486, 13487, 13488, 13489, 13490, 13491, 13492, 13493, 13494, 13495, 13496, 13497, 13498, 13499, 13500, 13501, 13502, 13503, 13504, 13505, 13506, 13507, 13508, 13509, 13510, 13511, 13512, 13513, 13514, 13515, 13516, 13517]
# badfile =  [19863, 19864, 19865, 19866, 19867, 19868, 19869, 19870, 19871, 19872, 19873, 19874, 19875, 19876, 19877, 19878, 19879, 19880, 19881, 19882, 19883, 19884, 19885, 19886, 19887, 19888, 19889, 19890, 19891, 19892, 19893, 19894, 19895, 19896, 19897, 19898, 19899, 19900, 19901, 19902, 19903, 19904, 19905, 19906, 19907, 19908, 19909, 19910, 19911, 19912, 19913, 19914, 19915, 19916, 19917, 19918, 19919, 19920, 19921, 19922, 19923, 19924, 19925, 19926, 19927, 19928, 19929, 19930, 19931, 19932, 19933, 19934, 19935, 19936, 19937, 19938, 19939, 19940, 19941, 19942, 19943, 19944, 19945, 19946, 19947, 19948, 19949, 19950, 19951, 19952, 19953, 19954, 19955, 19956, 19957, 19958, 19959, 19960, 19961, 19962, 19963, 19964, 19965, 19966, 19967, 19968, 19969, 19970, 19971, 19972, 19973, 19974, 19975, 19976, 19977, 19978, 19979, 19980, 19981, 19982, 19983, 19984, 19985, 19986, 19987, 19988, 19989, 19990, 19991, 19992]
badfile = []
print(df)
for idx, row in df.iterrows():
#     # print(idx)
#     if idx < 17560:
#         continue
    if len(badfile) != 0:
        if idx not in badfile:
            continue
    start = row['start']
    end   = row['end']

    if start > end:
        start, end = end, start

    print(row)

    # if start == end:
    #     end = start + 1.5

    # try:

    #     audio, sr = torchaudio.load(f"/data/datasets/ETRI_resize/{row['folder']}/{row['role']}.wav")
    #     print("Audio : ", idx, start, end, int(start*sr), int(end*sr))
    #     audio = audio[:, int(start*sr):int(end*sr)]
    #     torchaudio.save(f"/data/datasets/ETRI_resize/{idx}.wav", audio, sr)
    # except:
    #     print("Audio Error : ", idx, start, end)

    # try :
    #     print("Video : ",idx, start, end,int(start*25), int(end*25))

    #     video = decord.VideoReader(f"/data/datasets/ETRI_resize/{row['folder']}/{row['role']}.mp4")
    #     video = video.get_batch(range(int(start*25), int(end*25)))
    #     video = torch.tensor(video.asnumpy())
    #     # video = video.permute(1, 0, 2, 3)
    #     torchvision.io.write_video(f"/data/datasets/ETRI_resize/{idx}.mp4", video, fps=25)
    # except:
    #     print("Video Error : ", idx, start, end)

    # sys.stdout.flush()
    # gc.collect()

    # start = str(datetime.timedelta(seconds=(start)))
    # end = str(datetime.timedelta(seconds=end))
    
    path = f"/data/datasets/ETRI_resize/{row['folder']}/{row['role']}.mp4"
    print(f'ffmpeg -y -i {path} -ss {start} -to {end} -c copy /data/datasets/ETRI_resize/{idx}.mp4')
    os.system(f'ffmpeg -y -i {path} -ss {start} -to {end} /data/datasets/ETRI_resize/{idx}.mp4')
    # os.system(f'ffmpeg -i {path} -ss {start} -to {end} -c copy /data/datasets/ETRI_resize/{idx}.mp4')

    path = f"/data/datasets/ETRI_resize/{row['folder']}/{row['role']}.wav"
    print(f'ffmpeg -y -i {path} -ss {start} -to {end} -c copy /data/datasets/ETRI_resize/{idx}.wav')
    os.system(f'ffmpeg -y -i {path} -ss {start} -to {end} /data/datasets/ETRI_resize/{idx}.wav')
    # if idx == 1:
    #     break